name: 1.0.$(Rev:r)
jobs:
  - job: 
    displayName: Build
    pool:
      name: 'Hosted Windows 2019 with VS2019'
    steps:
      - script: |
          choco install docfx -y
        displayName: Install docfx
      
      - task: DotNetCoreCLI@2
        displayName: restore
        inputs:
          command: restore
          projects: src/MilestoneTG.NHibernate.Extensions.sln

      - task: DotNetCoreCLI@2
        displayName: Test
        inputs:
          command: test
          arguments: -c debug --logger trx --results-directory $(Agent.TempDirectory) -p:Altcover=true -p:AltCoverCobertura=$(Agent.TempDirectory)/coverage.xml
          projects: 'test/**.csproj'
          publishTestResults: false
        #continueOnError: true

      - task: Palmmedia.reportgenerator.reportgenerator-build-release-task.reportgenerator@4
        displayName: ReportGenerator
        inputs:
          reports: '$(Agent.TempDirectory)/coverage.xml'
          targetdir: '$(Agent.TempDirectory)/coverage'
          reporttypes: 'HtmlInline_AzurePipelines;Cobertura;Badges'
        enabled: false

      - task: PublishCodeCoverageResults@1
        displayName: Publish code coverage results
        inputs:
          codeCoverageTool: Cobertura
          summaryFileLocation: $(Agent.TempDirectory)/coverage.xml

      - task: PublishTestResults@2
        displayName: Publish test results
        inputs:
          failTaskOnFailedTests: true
          testResultsFiles: $(Agent.TempDirectory)/*.trx
          testResultsFormat: VSTest

      - task: MSBuild@1
        displayName: Build and package
        inputs:
          msbuildArguments: /t:pack /p:Version=$(Build.Number) /p:PackageOutputPath=$(Build.ArtifactStagingDirectory)
          configuration: release
          platform: any cpu
          solution: src/MilestoneTG.NHibernate.AspNetCore.sln

      - script: |
          docfx build
        displayName: Build docs
        workingDirectory: docs

      - task: PublishBuildArtifacts@1
        displayName: Publish build artifacts
        inputs:
          ArtifactName: drop
          PathtoPublish:  $(Build.ArtifactStagingDirectory)

      
      

      